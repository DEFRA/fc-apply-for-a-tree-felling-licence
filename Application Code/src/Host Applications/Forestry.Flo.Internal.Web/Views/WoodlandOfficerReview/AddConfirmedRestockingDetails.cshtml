@using Forestry.Flo.Internal.Web.Infrastructure
@using Forestry.Flo.Services.Common.Extensions
@using Forestry.Flo.Services.FellingLicenceApplications.Entities
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using Forestry.Flo.Services.FellingLicenceApplications.Extensions;

@model Forestry.Flo.Internal.Web.Models.WoodlandOfficerReview.AmendConfirmedRestockingDetailsViewModel;

@{
    ViewData["Title"] = $"Add restocking details for compartment {Model.ConfirmedFellingRestockingDetails.CompartmentName}";
    var user = new InternalUser(User);
    var rd = Model.ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails;
    var initialTotalHectares = rd.RestockingCompartmentTotalHectares ?? Model.ConfirmedFellingRestockingDetails.TotalHectares ?? 0;

    // Build a dictionary of CompartmentId and TotalHectares
    var compartmentHectaresDict = Model.SubmittedFlaPropertyCompartments
        .GroupBy(x => x.SubmittedCompartmentId)
        .Select(g => g.First())
        .ToDictionary(
            x => x.SubmittedCompartmentId,
            x => x.CompartmentArea
        );

    // Serialize to JSON for use in JavaScript
    var compartmentHectaresJson = System.Text.Json.JsonSerializer.Serialize(compartmentHectaresDict);
 
    var selectListItems = Model.SubmittedFlaPropertyCompartments
        .Where(x => x.SubmittedCompartmentId != Model.ConfirmedFellingRestockingDetails.SubmittedFlaPropertyCompartmentId)
        .Select(x => new SelectListItem
        {
            Text = x.Label,
            Value = x.SubmittedCompartmentId.ToString()
        })
        .ToList();

    var restockingTypes = rd.OperationType.AllowedRestockingForFellingType(false)
        .Where(x => x != TypeOfProposal.DoNotIntendToRestock);

    // When SubmittedFlaPropertyCompartments is empty - exclude Alternative Compartment Types
    if (!selectListItems.Any())
    {
        restockingTypes = restockingTypes.Where(x => !x.IsAlternativeCompartmentRestockingType());
    }

    var allowedRestocking =
        (new[] { TypeOfProposal.None })
        .Concat(restockingTypes)
        .Select(x => new SelectListItem()
        {
            Text = x.GetDisplayName(),
            Value = x.ToString()
        });
}

<div class="govuk-grid-column-full">

    <partial name="Partials/_ConfirmationMessageDisplay" />
    <partial name="Partials/_UserGuideDisplay" />
    <partial name="Partials/_PageErrors" />
    <partial name="Partials/_FellingLicenceApplicationSummary" model="Model.FellingLicenceApplicationSummary" />

    <form method="post">
        <input aria-hidden="True" type="hidden" asp-for="ApplicationId" />
        <input aria-hidden="True" type="hidden" asp-for="ConfirmedFellingRestockingDetails.SubmittedFlaPropertyCompartmentId" />
		<input aria-hidden="True" type="hidden" asp-for="ConfirmedFellingRestockingDetails.CompartmentNumber" />
		<input aria-hidden="True" type="hidden" asp-for="ConfirmedFellingRestockingDetails.TotalHectares" />
        <input aria-hidden="True" type="hidden" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.OperationType" />
		<input aria-hidden="True" type="hidden" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.ConfirmedRestockingDetailsId" />
        <input aria-hidden="True" type="hidden" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.ConfirmedRestockingSpecies" />
        <input aria-hidden="True" type="hidden" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.ConfirmedFellingDetailsId" />
        <input aria-hidden="True" type="hidden" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.RestockingCompartmentTotalHectares" />
        <input aria-hidden="True" type="hidden" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.RestockingCompartmentNumber" id="ConfirmedFellingRestockingDetails_ConfirmedRestockingDetails_RestockingCompartmentNumber" />


        <h1 class="govuk-heading-l">@ViewBag.Title</h1>

        <div class="govuk-grid-column-one-half">
            <div class="govuk-body">
                <div class="govuk-form-group">
                    <label class="govuk-heading-m" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.RestockingProposal">
                        Restocking operation type
                    </label>
                    <select class="govuk-select"
                            asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.RestockingProposal"
                            asp-items=allowedRestocking>
                    </select>
                </div>

                <div class="govuk-form-group" id="@nameof(rd.RestockingCompartmentId)">
                    <label class="govuk-heading-m" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.RestockingCompartmentId">
                        Alternative compartment to restock
                    </label>
                    <select class="govuk-select"
                            asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.RestockingCompartmentId"
                            asp-items=selectListItems
                            id="ConfirmedFellingRestockingDetails_ConfirmedRestockingDetails_RestockingCompartmentId">
                    </select>
                </div>
                <input type="hidden" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.RestockingCompartmentNumber" id="ConfirmedFellingRestockingDetails_ConfirmedRestockingDetails_RestockingCompartmentNumber" />

                <div class="govuk-form-group" id="@nameof(rd.RestockArea)">
                    <label class="govuk-heading-m" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.RestockArea">
                        Estimated area to be restocked
                    </label>
					<div id="area-to-be-felled-hint" class="govuk-hint">
                        The property profile has <span id="compartment-gross-size"></span> Ha as the gross size for this compartment.
					</div>
					<validation asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.RestockArea"></validation>
                    <div class="govuk-input__wrapper">
                        <input class="govuk-input govuk-input--width-5"
                               asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.RestockArea"
                               type="number" step="0.01"
                               aria-describedby="area-to-be-felled-hint"
                               value="@(rd.RestockArea)">
                        <div class="govuk-input__suffix" aria-hidden="true">ha</div>
                    </div>
                </div>
                <div class="govuk-form-group" id="@nameof(rd.PercentOpenSpace)">
                    <label class="govuk-heading-m" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.PercentOpenSpace">
                        Estimated percentage of the area that will be restocked
                    </label>
                    <validation asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.PercentOpenSpace"></validation>
                    <div class="govuk-input__wrapper">
                        <input class="govuk-input govuk-input--width-5 input-readonly" disabled="disabled" aria-readonly="true"
                               asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.PercentOpenSpace"
                               type="number" step="0.01"
                               aria-describedby="area-to-be-felled-hint"
                               value="@(initialTotalHectares > 0 ? Math.Round((rd.RestockArea ?? 0) / initialTotalHectares * 100, 2) : string.Empty)">
                        <div class="govuk-input__suffix" aria-hidden="true">%</div>
                    </div>
                </div>

                <div class="govuk-form-group" id="restocking-density-group">
                    <label class="govuk-heading-m" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.RestockingDensity">
                        Estimate of the restocking density
                    </label>
                    <validation asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.RestockingDensity"></validation>
                    <div class="govuk-input__wrapper">
                        <input class="govuk-input govuk-input--width-5"
                               asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.RestockingDensity"
                               type="number"
                               aria-describedby="stems-per-ha">
                        <div class="govuk-input__suffix" aria-hidden="true">Stems per Ha</div>
                    </div>
                </div>

                <div class="govuk-form-group" id="number-of-trees-group">
                    <label class="govuk-heading-m" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.NumberOfTrees">
                        Estimated number of trees to be restocked
                    </label>
                    <validation asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.NumberOfTrees"></validation>
                    <div class="govuk-input__wrapper">
                        <input class="govuk-input govuk-input--width-10"
                               asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.NumberOfTrees"
                               type="number"
                               aria-describedby="stems-per-ha">
                        <div class="govuk-input__suffix" aria-hidden="true">Trees</div>
                    </div>
                </div>

                @{
                    var viewData = new ViewDataDictionary(ViewData)
                    {
                        TemplateInfo =
                                {
                                HtmlFieldPrefix = "Species"
                                },
                        ["FormPrefix"] = "restocking"
                    };
                }

                <div id="restocking-tree-species-selection-form-group" class="govuk-form-group">
                    <input type="hidden" aria-hidden="true" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.ConfirmedRestockingSpecies" />
                    <label class="govuk-heading-m" for="restocking-tree-species-select">
                        What species of trees will be restocked?
                    </label>
                    <div id="species-hint" class="govuk-hint">
                        Start typing to search, then select a species from the list.
                    </div>
                    <validation id="restocking-tree-species-error" asp-for="ConfirmedFellingRestockingDetails.ConfirmedRestockingDetails.ConfirmedRestockingSpecies"></validation>
                    <partial name="Partials/_TreeSpeciesSelection" model="@Model.Species" view-data="viewData" />
                </div>

                <div class="govuk-form-group">
                    <div class="govuk-button-group">

                        <button type="submit" class="govuk-button" data-module="govuk-button">
                            Save
                        </button>

                        <a class="govuk-link" asp-action="ConfirmedFellingAndRestocking" asp-route-id="@Model.ApplicationId" title="Abandon changes and return to the summary">Cancel</a>

                    </div>
                </div>

            </div>
        </div>
    </form>
</div>

@section Scripts
{
    <script src="/js/accessible-autocomplete.min.js"></script>
    <script src="/js/tree-species-selection.js" asp-append-version="true"></script>
    <script src="/js/amend-restocking-details.js" asp-append-version="true"></script>
    <script>
        var compartmentHectares = @Html.Raw(compartmentHectaresJson);
</script>

    @if (!Model.Editable(user))
    {
        <script src="/js/disable-form-elements.js"></script>

        <script>

            $(function () {

                disableFormElements('#felling-detail-form');
            });

        </script>
    }
}

@section breadcrumbs
{
    <partial name="Partials/_BreadcrumbsMenu" model="@Model.Breadcrumbs" />
}
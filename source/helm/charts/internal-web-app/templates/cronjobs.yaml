{{- /* Grab the jobs map safely from the subchart's values */ -}}
{{- $jobs := default dict (index .Values "config" "cronJobs" "jobs") -}}

{{- /* voluntary-withdrawal-notification */ -}}
{{- $job := index $jobs "voluntary-withdrawal-notification" -}}
{{- if and $job $job.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $job.name }}
spec:
  schedule: {{ $job.schedule | quote }}
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: {{ $job.name }}
              image: fsflo.azurecr.io/docker/qtools:1.2.1
              imagePullPolicy: IfNotPresent
              env:
                - name: API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.global.secret_key_ref_name }}
                      key:  {{ index .Values "config" "cronJobs" "apiKey" "secret_key" }}
              command:
                - bash
                - -c
                - |
                  set -euo pipefail

                  echo "[$(date)] CronJob '{{ $job.name }}' starting"
                  echo "[$(date)] Calling: http://{{ include "internal-web-app.fullname" . }}:{{ .Values.service.port }}{{ $job.path }}"

                  curl -sSf -k \
                    -H "X-Api-Key: ${API_KEY}" \
                    "http://{{ include "internal-web-app.fullname" . }}:{{ .Values.service.port }}{{ $job.path }}"

                  echo "[$(date)] CronJob '{{ $job.name }}' completed successfully"
{{- end }}
---
{{- /* extend-applications */ -}}
{{- $job = index $jobs "extend-applications" -}}
{{- if and $job $job.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $job.name }}
spec:
  schedule: {{ $job.schedule | quote }}
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: {{ $job.name }}
              image: fsflo.azurecr.io/docker/qtools:1.2.1
              imagePullPolicy: IfNotPresent
              env:
                - name: API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.global.secret_key_ref_name }}
                      key:  {{ index .Values "config" "cronJobs" "apiKey" "secret_key" }}
              command:
                - bash
                - -c
                - |
                  set -euo pipefail

                  echo "[$(date)] CronJob '{{ $job.name }}' starting"
                  echo "[$(date)] Calling: http://{{ include "internal-web-app.fullname" . }}:{{ .Values.service.port }}{{ $job.path }}"

                  curl -sSf -k \
                    -H "X-Api-Key: ${API_KEY}" \
                    "http://{{ include "internal-web-app.fullname" . }}:{{ .Values.service.port }}{{ $job.path }}"

                  echo "[$(date)] CronJob '{{ $job.name }}' completed successfully"
{{- end }}
---
{{- /* public-register-expiry-notification */ -}}
{{- $job = index $jobs "public-register-expiry-notification" -}}
{{- if and $job $job.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $job.name }}
spec:
  schedule: {{ $job.schedule | quote }}
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: {{ $job.name }}
              image: fsflo.azurecr.io/docker/qtools:1.2.1
              imagePullPolicy: IfNotPresent
              env:
                - name: API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.global.secret_key_ref_name }}
                      key:  {{ index .Values "config" "cronJobs" "apiKey" "secret_key" }}
              command:
                - bash
                - -c
                - |
                  set -euo pipefail

                  echo "[$(date)] CronJob '{{ $job.name }}' starting"
                  echo "[$(date)] Calling: http://{{ include "internal-web-app.fullname" . }}:{{ .Values.service.port }}{{ $job.path }}"

                  curl -sSf -k \
                    -H "X-Api-Key: ${API_KEY}" \
                    "http://{{ include "internal-web-app.fullname" . }}:{{ .Values.service.port }}{{ $job.path }}"

                  echo "[$(date)] CronJob '{{ $job.name }}' completed successfully"
{{- end }}
---
{{- /* remove-applications-from-decision-public-register */ -}}
{{- $job = index $jobs "remove-applications-from-decision-public-register" -}}
{{- if and $job $job.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $job.name }}
spec:
  schedule: {{ $job.schedule | quote }}
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: {{ $job.name }}
              image: fsflo.azurecr.io/docker/qtools:1.2.1
              imagePullPolicy: IfNotPresent
              env:
                - name: API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.global.secret_key_ref_name }}
                      key:  {{ index .Values "config" "cronJobs" "apiKey" "secret_key" }}
              command:
                - bash
                - -c
                - |
                  set -euo pipefail

                  echo "[$(date)] CronJob '{{ $job.name }}' starting"
                  echo "[$(date)] Calling: http://{{ include "internal-web-app.fullname" . }}:{{ .Values.service.port }}{{ $job.path }}"

                  curl -sSf -k \
                    -H "X-Api-Key: ${API_KEY}" \
                    "http://{{ include "internal-web-app.fullname" . }}:{{ .Values.service.port }}{{ $job.path }}"

                  echo "[$(date)] CronJob '{{ $job.name }}' completed successfully"
{{- end }}
---
{{- /* public-register-consultation-comments */ -}}
{{- $job = index $jobs "public-register-consultation-comments" -}}
{{- if and $job $job.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $job.name }}
spec:
  schedule: {{ $job.schedule | quote }}
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: {{ $job.name }}
              image: fsflo.azurecr.io/docker/qtools:1.2.1
              imagePullPolicy: IfNotPresent
              env:
                - name: API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.global.secret_key_ref_name }}
                      key:  {{ index .Values "config" "cronJobs" "apiKey" "secret_key" }}
              command:
                - bash
                - -c
                - |
                  set -euo pipefail

                  echo "[$(date)] CronJob '{{ $job.name }}' starting"
                  echo "[$(date)] Calling: http://{{ include "internal-web-app.fullname" . }}:{{ .Values.service.port }}{{ $job.path }}"

                  curl -sSf -k \
                    -H "X-Api-Key: ${API_KEY}" \
                    "http://{{ include "internal-web-app.fullname" . }}:{{ .Values.service.port }}{{ $job.path }}"

                  echo "[$(date)] CronJob '{{ $job.name }}' completed successfully"
{{- end }}

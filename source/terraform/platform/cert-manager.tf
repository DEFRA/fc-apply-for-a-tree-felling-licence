resource "kubernetes_namespace" "cert-manager" {
  metadata {
    name = "cert-manager"

    labels = {
      "kubernetes.io/metadata.name" = "cert-manager"
      "name"                        = "cert-manager"
    }
  }
}

resource "kubernetes_secret" "ca-key-pair" {
  metadata {
    name      = "ca-key-pair"
    namespace = kubernetes_namespace.cert-manager.metadata[0].name
  }

  binary_data = {
    "tls.crt" = "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tDQpNSUlGdXpDQ0E2T2dBd0lCQWdJVE53QUFBQkwyTDYwNFNWQ1NhZ0FBQUFBQUVqQU5CZ2txaGtpRzl3MEJBUXNGDQpBREFkTVJzd0dRWURWUVFERXhKUmRXbGphM05wYkhaaElGSnZiM1FnUTBFd0hoY05NakV4TURBMk1UVTBPRFUwDQpXaGNOTXpjd01UTXdNVEUxTlRFMFdqQlZNUXN3Q1FZRFZRUUdFd0pWU3pFU01CQUdBMVVFQ0JNSlYybHNkSE5vDQphWEpsTVJNd0VRWURWUVFLRXdwUmRXbGphM05wYkhaaE1SMHdHd1lEVlFRREV4UnpaV1ZSWlhJZ1EyeDFjM1JsDQpjaUJUZFdKRFFUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQUk4dHI3ekt5L2E5DQpFUk4rYzZOMzBEdDJtZVdITmdZWjgrSGFQS09QU284VlJ2R1lHb1JtZWxUWGtBRXI0Yk9NUzhIbzRuaXM0alB3DQpxWEl5VjFDUGU1VzVESXZhK3NTZXhFenBvS0Nrd2I4VHB6dzBaa1IvWm8xRFFpN29OVE5rNW9jZ2tqaEg3b2R0DQpEeVFKWHpIN1gvVm5wYms5OVBFZjlrUSs3T0R2Z2FhZDJPYlhFREFHdWxydzhwZEYxK3cxc1VKYzAwdmpMRCtQDQpZNUdmZXRYdVdXMGRZRUxQNTdjMU9FWC9mR3lkcEU5VndhS3Y5K010bzNPNWxFTEhkQ1lBVm43ZDJFRzBOMmhSDQpISWdxbk9KbFlXK2Q0S3ZZOWlLVWsvRG9IdklTTTBBWFVKTjRpRlliOW9JSW9sNHM2cjI3SzRSdHBONjM4aU5rDQpEUFNyZ092QUNOTUNBd0VBQWFPQ0Fib3dnZ0cyTUJJR0ExVWRFd0VCL3dRSU1BWUJBZjhDQVFBd0hRWURWUjBPDQpCQllFRkNYWDJkUEMwdnJhRVpyV0JkaWpBTlo4bUs3ZE1Bc0dBMVVkRHdRRUF3SUJoakFmQmdOVkhTTUVHREFXDQpnQlJ0QkpHS3BqYlBxTHJOTWtTWUo4WkJ2UnAyYkRDQmp3WURWUjBmQklHSE1JR0VNSUdCb0grZ2ZZWXphSFIwDQpjRG92TDNCcmFTNXhlR3gyWVM1amIyMHZZMlJ3TDFGMWFXTnJjMmxzZG1FbE1qQlNiMjkwSlRJd1EwRXVZM0pzDQpoa1pvZEhSd09pOHZjR3RwTG5GMWFXTnJjMmxzZG1FdWRHaHBjbVJ3WVhKMGVTNXVhSE11ZFdzdlkyUndMMUYxDQphV05yYzJsc2RtRWxNakJTYjI5MEpUSXdRMEV1WTNKc01JR2xCZ2dyQmdFRkJRY0JBUVNCbURDQmxUQS9CZ2dyDQpCZ0VGQlFjd0FvWXphSFIwY0RvdkwzQnJhUzV4ZUd4MllTNWpiMjB2WVdsaEwxRjFhV05yYzJsc2RtRWxNakJTDQpiMjkwSlRJd1EwRXVZM0owTUZJR0NDc0dBUVVGQnpBQ2hrWm9kSFJ3T2k4dmNHdHBMbkYxYVdOcmMybHNkbUV1DQpkR2hwY21Sd1lYSjBlUzV1YUhNdWRXc3ZZV2xoTDFGMWFXTnJjMmxzZG1FbE1qQlNiMjkwSlRJd1EwRXVZM0owDQpNQmtHQ1NzR0FRUUJnamNVQWdRTUhnb0FVd0IxQUdJQVF3QkJNQTBHQ1NxR1NJYjNEUUVCQ3dVQUE0SUNBUUJFDQpRR0F3RkVRZHpkazlNMEtieWdCS2xNaC8yU1VWT3NKMHRVV0NsMHNScDdVb2hWZ3FNWDdIb05Nei9ISVRydVRqDQpkUFpzTC9lTkdaZWxRRmZoVnI5d0kyTVJuZzcvN29yaUd2WUVsaEYyVnhDdkIvdnlub1NQcUo3dGR0L1BCS2NsDQpzOXBwbG5YUnJlY3ZIQWZwMnZJTGVFVHJTRXRaSkZaaDc3RlA3ekFvOHovdTRKL1E4VldudXRpUithN1FuQUtYDQp3SGtEUkFFZHA1Y0xrY0lid0Q1ejlSZURnZjNIbHlpL1lNQkEvY1l3S2kvZkhTWndGdGlXYUJEMXc2SVpqdXFPDQpaeGIxNGYrN1VTODdqNDZTSnRxb1BQanNraTJRSEhHb1BvbTd4TUxDQlFQRzlLQnoxZGR1Zk4yUDhQWTVkQk5EDQpCTEhGcG9lVUtVSHZIK2lhVDIrMzI3bit0QmluSUl0TC9XL1JQaHZST2FmZ0dySW5ycFdSeXU0VEViUUllV2lpDQpNZEt0TlhEd2RiRzBtemtLVW0yekQ4YXJBMUhoRDFULzh4VVJnLzk5aFBCeURLeUJsRW9VeXVrNUZKMU45bGxQDQpjOElUM1Q2RXcyMWlibmN1NXZzRmxiZTNHYytGQkZOSW95bjNkTzQ2Sk9WQ1BjRmNnR0c5R0lpdkRhL1poNnVPDQo5WnliWnErc3R6VFdMdnd0TU9TQm9DV0xSVFB6N1RLNjRaWGJSa0phcXpxL0FuTEhOMmh2UkNLeWN1SHVlTEExDQo5OTFRZjhRZHBEblBBTlZiMmpLV2hOay9MdlpFaW9CRGVVcFVIcjdKa3NsRjNNMk5aVG1yMWI5dkVpRXlhM0xEDQpDcnpEeUoxa0pFUzJNcmZvS3BLdk8rM0Z4cmw5VFpMN1E1SDVWblBPOGc9PQ0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQ0K"
    "tls.key" = "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb2dJQkFBS0NBUUVBankydnZNckw5cjBSRTM1em8zZlFPM2FaNVljMkJobno0ZG84bzQ5S2p4Vkc4WmdhCmhHWjZWTmVRQVN2aHM0eEx3ZWppZUt6aU0vQ3BjakpYVUk5N2xia01pOXI2eEo3RVRPbWdvS1RCdnhPblBEUm0KUkg5bWpVTkNMdWcxTTJUbWh5Q1NPRWZ1aDIwUEpBbGZNZnRmOVdlbHVUMzA4Ui8yUkQ3czRPK0JwcDNZNXRjUQpNQWE2V3ZEeWwwWFg3RFd4UWx6VFMrTXNQNDlqa1o5NjFlNVpiUjFnUXMvbnR6VTRSZjk4Ykoya1QxWEJvcS8zCjR5MmpjN21VUXNkMEpnQldmdDNZUWJRM2FGRWNpQ3FjNG1WaGI1M2dxOWoySXBTVDhPZ2U4aEl6UUJkUWszaUkKVmh2MmdnaWlYaXpxdmJzcmhHMmszcmZ5STJRTTlLdUE2OEFJMHdJREFRQUJBb0lCQUNGSXFwakZ3QUo4MHpKbgo2L1B0VDEvell6VkRhR0NrdWRnZ0JvYXpNYzd2VUUycllVYTBGKzRQS20vTFJxMlppS2JzUDNGMEp5V1I1YUloClo4RFhpaEExTTJCenFHWDZ6b0Zlc2pPRitYQTAzbVNWZmN5Z25UTnJsa0FYUlA3TWp2YU1zTkVhajYyMXdaWk0KQTNBNEVvZVc3NlNQYlpoOEtLQ1d6RFJDR1M2bEhBM1YvdEdpbUVOc1haWWFNSlVxU1NOeXBFUlN2eUt6Q0JSSQp2eCtUN2IvYUpvTEVLUG5LTnJGb0NnVW84Q3NTbjVFSExJcUJFT2JXY1pEUTRlWjk0TXRoZGdkcWNBclBLNVFtCnVKdlI1RHdxdW0wSVpPZ2lQVVdwNlZ4a3Izd3czRGhLOHNFSWo5QUtncjA4SkxMdG5FcllZZDJmZjJ2cS9zbWoKRHY1Q2pma0NnWUVBdVJYdWU5cUxxQVd3TmRYM1dRVUpRSEFUZlFDZ3dST0dRUVNZZnRjQmlTcjZCU09YR3pSWQpaT0tPU09XVjdVK0hSOWxEQjBDUjBGdVBteEVUaWl3Q3FDcSswRU1NMnpnV09ZZzlPRmYxSGdXeFcxU1hFKy9RCldnYjNxU0N6T1pSSlVNaXBOdHZseExPU2Y1TzQ4a3doZVg0S2V4ZVZ0NFMvdWZVUVA3SEVxMzhDZ1lFQXhnbE0KeUxNVjZyR0cwdjYxeGxoZEZOeGZTWUhXTW10ZGJMTDBuSU5yU1l5UDVsK05CWndxVk82dUJjQnFIREJ3YXBHYgo1VjJSNy9iYWtnenBuMWlsOWx4SWk2c1pia2dTREVOMGg2Sk95ajVOaUtlM0VsVEtmTEUxT0NrMzdScXZRa09TCnVYQysvbVVNV0dYaTlVaVQrb0hZOWNFZzk4MW1GdDEvaE1FSjNLMENnWUJIa2NGOFJ4QUYwdDFHbEF4bmNka1gKLzc2cGNacTN6bEwxeFU4cWpQMWRDeTlPMldwTzdMalptZm1uR3BBVkNkR242TTFRZXBsbjFsLzdlR2p6M3Z6UQpCbWR1cE43TnppeFo1dUsxYk4ydDFFbTJwVWtlUG5kMHVJai83MU1laXNhbTVGRDZrNkdQcEZpYjJJV0Z2QWFkCnNpMWZWOGxmQTRnWDRqbDhSOE5qQlFLQmdDZ0lPVDFZOWxVN0RjWVpOeVdoTnkvQVhJSy9mRTAwNXUzU1B5QmsKY0l1dG5ta3paNDU2d3hQb0s4VjkzL1ZTMVdhMWlJNFZIQ3NsKzRrS2t5OWkvQ21RL2hrOXZTWk42MWdQU3I4ZwpVRTBSeXhxVXpLMG45c2ErQzhRT2tQK2RKVkIvMkdra0lYZkxkWE5wSlRmd00vbXZ4ZXZuM29JNVF5bmNIS3I1CldzVUJBb0dBVGdWWEhOV1dJWlBQcXRMcEJMZDFpWUx6eG9PTjRqWmxDUWtKdjNHSTRqL0hEc3dSUjZiVFhUMWMKZVRHNmljL1Q5MzY3akdRS2ZIMThTSnlYQ0hMT1VWRXd2SncwTVdDMjlQVkhCaU1oL0pBU3FvSEVkY2tjQnQ0WApNMDZiSi9NbXNUZllqMnBjbVQ2WGI4azU1NFF0ZzgvQjIzTTBsZmw2ZUxaWjAxeFFzdDg9Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg=="
  }

  type = "kubernetes.io/tls"

}

resource "kubernetes_secret" "cloudflare-api-token" {
  metadata {
    name      = "cloudflare-api-token"
    namespace = kubernetes_namespace.cert-manager.metadata[0].name
  }

  data = {
    api-token = "${var.cloudflare_api_token}"
  }

  type = "opaque"
}


# Deploy Cert Manager
resource "helm_release" "cert-manager" {
  name       = var.cert_manager_chart
  repository = var.cert_manager_repository
  chart      = var.cert_manager_chart
  namespace  = kubernetes_namespace.cert-manager.metadata[0].name

  create_namespace = false

  values = [
    file("values/cert-manager/values.yaml")
  ]

  #depends_on = [
  #  helm_release.kube-prometheus-stack
  #]
}


resource "kubectl_manifest" "ca-issuer" {
  yaml_body = file("values/cert-manager/ca-issuer.yaml")

  depends_on = [
    kubernetes_secret.ca-key-pair,
    helm_release.cert-manager
  ]

}

resource "kubectl_manifest" "le-issuer" {
  yaml_body = file("values/cert-manager/le-issuer.yaml")

  depends_on = [
    kubernetes_secret.cloudflare-api-token,
    helm_release.cert-manager
  ]

}

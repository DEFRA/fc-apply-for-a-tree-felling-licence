<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Test</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.23/esri/themes/light/main.css"> 
    <script src="https://js.arcgis.com/4.23/"></script>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      #mainWindow {
        padding: .5em;
        background-color: #fff;
      }
      #mainWindow p, #uploadForm {
          display: block;
          padding: .1em;
        }
    </style>


<script>
   require([   "esri/config",
               "esri/Map", 
               "esri/views/MapView",
               "esri/widgets/ScaleBar",
               "esri/Graphic",
               "esri/layers/GraphicsLayer",
               "esri/widgets/Search",
               "esri/widgets/Sketch",
               "esri/widgets/Measurement",
               "esri/widgets/CoordinateConversion",
               "esri/widgets/BasemapToggle",
               "esri/widgets/BasemapGallery",
               "esri/widgets/Expand",
               "esri/request",
               "esri/layers/FeatureLayer",
               "esri/layers/support/Field"
            ]
            , function (esriConfig,Map, MapView, ScaleBar, Graphic, GraphicsLayer, 
               Search, Sketch, Measurement, CoordinateConversion, BasemapToggle, BasemapGallery, Expand, request, FeatureLayer, Field) {

   esriConfig.apiKey = "AAPKad86df7c8a244ece978d49dd88f8e528X3dpEcjo01r1O4mv9plFfKA7EcPVSgcbc5rQB7GYwBCKDEBdua_VLKULnDsgbs1K";

   const portalUrl = "https://www.arcgis.com";


   document
          .getElementById("uploadForm")
          .addEventListener("change", (event) => {
            const fileName = event.target.value.toLowerCase();

            if (fileName.indexOf(".zip") !== -1) {
              //is file a zip - if not notify user
              generateFeatureCollection(fileName);
            } else {
              document.getElementById("upload-status").innerHTML =
                '<p style="color:red">Add shapefile as .zip file</p>';
            }
          });



   const map = new Map({
      basemap: "arcgis-topographic" //Basemap layer service
   });

 

  const view = new MapView({
    map: map,
    center: [-2.587910, 51.454514], //Longitude, latitude
    zoom: 18,
    container: "viewDiv"
 });

 const fileForm = document.getElementById("mainWindow");

const expand = new Expand({
  expandIconClass: "esri-icon-upload",
  view: view,
  content: fileForm
});

view.ui.add(expand, "top-right");

///

function generateFeatureCollection(fileName) {
          let name = fileName.split(".");
          // Chrome adds c:\fakepath to the value - we need to remove it
          name = name[0].replace("c:\\fakepath\\", "");

          document.getElementById("upload-status").innerHTML =
            "<b>Loading </b>" + name;

          // define the input params for generate see the rest doc for details
          // https://developers.arcgis.com/rest/users-groups-and-items/generate.htm
          const params = {
            name: name,
            targetSR: view.spatialReference,
            maxRecordCount: 1000,
            enforceInputFileSizeLimit: true,
            enforceOutputJsonSizeLimit: true
          };

          // generalize features to 10 meters for better performance
          params.generalize = true;
          params.maxAllowableOffset = 10;
          params.reducePrecision = true;
          params.numberOfDigitsAfterDecimal = 0;

          const myContent = {
            filetype: "shapefile",
            publishParameters: JSON.stringify(params),
            f: "json"
          };

          // use the REST generate operation to generate a feature collection from the zipped shapefile
          request(portalUrl + "/sharing/rest/content/features/generate", {
            query: myContent,
            body: document.getElementById("uploadForm"),
            responseType: "json"
          })
            .then((response) => {
              const layerName =
                response.data.featureCollection.layers[0].layerDefinition.name;
              document.getElementById("upload-status").innerHTML =
                "<b>Loaded: </b>" + layerName;
              addShapefileToMap(response.data.featureCollection);
            })
            .catch(errorHandler);
        }

        function errorHandler(error) {
          document.getElementById("upload-status").innerHTML =
            "<p style='color:red;max-width: 500px;'>" + error.message + "</p>";
        }

        function addShapefileToMap(featureCollection) {
          // add the shapefile to the map and zoom to the feature collection extent
          // if you want to persist the feature collection when you reload browser, you could store the
          // collection in local storage by serializing the layer using featureLayer.toJson()
          // see the 'Feature Collection in Local Storage' sample for an example of how to work with local storage
          let sourceGraphics = [];

          const layers = featureCollection.layers.map((layer) => {
            const graphics = layer.featureSet.features.map((feature) => {
              return Graphic.fromJSON(feature);
            });
            sourceGraphics = sourceGraphics.concat(graphics);
            const featureLayer = new FeatureLayer({
              objectIdField: "FID",
              source: graphics,
              fields: layer.layerDefinition.fields.map((field) => {
                return Field.fromJSON(field);
              })
            });
            return featureLayer;
            // associate the feature with the popup on click to enable highlight and zoom to
          });
          map.addMany(layers);
          view.goTo(sourceGraphics).catch((error) => {
            if (error.name != "AbortError") {
              console.error(error);
            }
          });

          document.getElementById("upload-status").innerHTML = "";
        }
      

///

 const graphicsLayer = new GraphicsLayer();
 map.add(graphicsLayer);

//  const sketchGraphicsLayer = new GraphicsLayer();
//  map.add(sketchGraphicsLayer);


 const point = { //Create a point
    type: "point",
    longitude: -2.587910,
    latitude: 51.454514
 };
 const simpleMarkerSymbol = {
    type: "simple-marker",
    color: [226, 119, 40],  // Orange
    outline: {
        color: [255, 255, 255], // White
        width: 1
    }
 };

 const pointGraphic = new Graphic({
    geometry: point,
    symbol: simpleMarkerSymbol
 });
 graphicsLayer.add(pointGraphic);

    // Create a line geometry
 const polyline = {
    type: "polyline",
    paths: [
        [-2.521527826096, 51.4139576938577], //Longitude, latitude
        [-2.514893761649, 51.4080602407843], //Longitude, latitude
        [-2.508878330345, 51.4016642996246]  //Longitude, latitude
    ]
 };
 const simpleLineSymbol = {
    type: "simple-line",
    color: [226, 119, 40], // Orange
    width: 2
 };

 const polylineGraphic = new Graphic({
    geometry: polyline,
    symbol: simpleLineSymbol
 });
 graphicsLayer.add(polylineGraphic);

 // Create a polygon geometry
 const polygon = {
    type: "polygon",
    rings: [
        [-2.518984489994, 51.4137559967283], //Longitude, latitude
        [-2.506796597377, 51.4215816298725], //Longitude, latitude
        [-2.491432890735, 51.4163883241613], //Longitude, latitude
        [-2.49596686535, 51.408564864635],   //Longitude, latitude
        [-2.508558110679, 51.4035027131376]  //Longitude, latitude
    ]
 };

 const simpleFillSymbol = {
    type: "simple-fill",
    color: [227, 139, 79, 0.8],  // Orange, opacity 80%
    outline: {
        color: [255, 255, 255],
        width: 1
    }
 };

 const popupTemplate = {
    title: "{Name}",
    content: "{Description}"
 }
 const attributes = {
    Name: "Graphic",
    Description: "I am a polygon"
 }
 const polygonGraphic = new Graphic({
    geometry: polygon,
    symbol: simpleFillSymbol,

    attributes: attributes,
    popupTemplate: popupTemplate

 });
 graphicsLayer.add(polygonGraphic);

	const searchWidget = new Search({
		view: view
	  });

	view.ui.add(searchWidget, {
		position: "top-right"
	  });

	/* only sems that this tool will do the area measurment when visible, and only then when you're click to use it will it do area measuring*/  
	  const measurement = new Measurement({
	  view: view,
	  activeTool: "area",
	  areaUnit: "hectares",
	  visible: true
	});

   view.ui.add(measurement, "top-right");


   const basemapToggle = new BasemapToggle({
        view: view,
        nextBasemap: "arcgis-imagery"
     });

     view.ui.add(basemapToggle,"bottom-right");

     const basemapGallery = new BasemapGallery({
        view: view,
        source: {
          query: {
            title: '"World Basemaps for Developers" AND owner:esri'
          }
        }
      });

      view.ui.add(basemapGallery, "top-left"); // Add to the view

  view.when(() => {
          const sketch = new Sketch({
            layer: graphicsLayer,
            view: view,
            availableCreateTools: ["polygon", "rectangle"],
            creationMode: "update", // graphic will be selected as soon as it is created
            updateOnGraphicClick: true,
            visibleElements: {
               createTools: {
               point: false,
               circle: false
               },
               selectionTools:{
               "lasso-selection": false,
               "rectangle-selection":false,
               },
               settingsMenu: false,
               undoRedoMenu: false
            }
          });
          view.ui.add(sketch, "top-right");
          
          sketch.on("create", function(event) {
            // check if the create event's state has changed to complete indicating
            // the graphic create operation is completed.
            if (event.state === "complete") {
               handleEvent(event.graphic.geometry);
               console.log(event.graphic.geometry);
            }
         });

         sketch.on("update", function(event) {
            // check if the create event's state has changed to complete indicating
            // the graphic create operation is completed.
            if (event.state === "complete") {
               handleEvent(event.graphics[0].geometry);
               console.log(event.graphics[0].geometry);
            }
         });
        });

      //show co-ords on screen - can be preset for long/lat?
      const ccWidget = new CoordinateConversion({
         view: view,
         visibleElements: {
            settingsButton : false,
            expandButton: false,
            editButton: false,
            captureButton: false
         }
      });

      view.ui.add(ccWidget, "bottom-left");

 // places the logo div in the bottom right corner of the view
 view.ui.add("logoDiv", "bottom-right");

 var scalebar = new ScaleBar({
   view: view,
          unit: "dual" // The scale bar displays both metric and non-metric units.
  });

   view.ui.add(scalebar, {
   position: "bottom-left"
   });


function handleEvent(eventGeometry){

   alert('isSelfIntersecting: '+eventGeometry.isSelfIntersecting +
   '\nType: ' + eventGeometry.type +
   '\nwkid (id of coordinate system): ' + eventGeometry.spatialReference.wkid +
   '\n\nGeometry:\n' + eventGeometry.rings.toString())
}

 });
</script>
</head>

<body>
   <div id="mainWindow">
     <div>
       <div style="padding-left:4px;">
         <p>Add a zipped shapefile to the map.</p>
        
         <form enctype="multipart/form-data" method="post" id="uploadForm">
           <div class="field">
             <label class="file-upload">
               <span><strong>Add File</strong></span>
               <input type="file" name="file" id="inFile" />
             </label>
           </div>
         </form>
         <span
           class="file-upload-status"
           style="opacity:1;"
           id="upload-status"
         ></span>
         <div id="fileInfo"></div>
       </div>
     </div>
   </div>
   <div id="viewDiv"></div>
   <div id="logoDiv" class="esri-widget">Logo</div>
 </body>
</html>